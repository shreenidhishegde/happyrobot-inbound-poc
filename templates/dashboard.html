<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HappyRobot Inbound Carrier Sales Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        .metric-label {
            color: #666;
            font-size: 0.9em;
        }
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .chart-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin: 10px 0;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        .refresh-btn:hover {
            background: #5a6fd8;
        }
        .api-links {
            text-align: center;
            margin-top: 30px;
        }
        .api-links a {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin: 5px;
        }
        .api-links a:hover {
            background: #5a6fd8;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöõ HappyRobot Inbound Carrier Sales</h1>
        <p>Real-time Dashboard & Analytics</p>
    </div>

    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-label">Total Loads Available</div>
            <div class="metric-value" id="total-loads">-</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Total Calls</div>
            <div class="metric-value" id="total-calls">-</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Today's Calls</div>
            <div class="metric-value" id="today-calls">-</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">This Week's Calls</div>
            <div class="metric-value" id="week-calls">-</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Success Rate</div>
            <div class="metric-value" id="success-rate">-</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Unique Carriers</div>
            <div class="metric-value" id="unique-carriers">-</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Booked Calls</div>
            <div class="metric-value" id="booked-calls">-</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Callback Needed</div>
            <div class="metric-value" id="callback-needed">-</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Avg Call Duration</div>
            <div class="metric-value" id="avg-duration">-</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Longest Call</div>
            <div class="metric-value" id="max-duration">-</div>
        </div>
    </div>

    <div class="chart-container">
        <div class="chart-title">üìä Load Distribution by Equipment Type</div>
        <canvas id="equipmentChart" width="400" height="200"></canvas>
    </div>

    <div class="chart-container">
        <div class="chart-title">üìà Call Outcomes</div>
        <canvas id="outcomesChart" width="400" height="200"></canvas>
    </div>

    <div class="chart-container">
        <div class="chart-title">üìà 7-Day Call Activity</div>
        <canvas id="activityChart" width="400" height="200"></canvas>
    </div>

    <div class="chart-container">
        <div class="chart-title">üöõ Top Carriers by Call Volume</div>
        <canvas id="carriersChart" width="400" height="200"></canvas>
    </div>

    <div class="chart-container">
        <div class="chart-title">‚è±Ô∏è Call Duration by Outcome</div>
        <canvas id="durationChart" width="400" height="200"></canvas>
    </div>

    <div class="chart-container">
        <div class="chart-title">üïê Hourly Call Distribution</div>
        <canvas id="hourlyChart" width="400" height="200"></canvas>
    </div>

    <button class="refresh-btn" onclick="refreshDashboard()">üîÑ Refresh Data</button>

    <div class="api-links">
        <a href="/docs">API Documentation</a>
        <a href="/loads">View Loads</a>
        <a href="/dashboard-metrics">Raw Metrics JSON</a>
    </div>

    <script>
        // Load dashboard data
        async function loadDashboardData() {
            try {
                const [metrics, loads] = await Promise.all([
                    fetch('/dashboard-metrics').then(r => r.json()),
                    fetch('/loads').then(r => r.json())
                ]);

                // Update metric cards
                document.getElementById('total-loads').textContent = loads.length;
                document.getElementById('total-calls').textContent = metrics.total_calls || 0;
                document.getElementById('today-calls').textContent = metrics.today_calls || 0;
                document.getElementById('week-calls').textContent = metrics.week_calls || 0;
                document.getElementById('success-rate').textContent = (metrics.success_rate || 0) + '%';
                document.getElementById('unique-carriers').textContent = metrics.unique_carriers || 0;
                document.getElementById('booked-calls').textContent = metrics.booked_calls || 0;
                document.getElementById('callback-needed').textContent = metrics.callback_needed || 0;
                document.getElementById('avg-duration').textContent = (metrics.avg_duration || 0) + 's';
                document.getElementById('max-duration').textContent = (metrics.max_duration || 0) + 's';

                // Equipment type chart
                const equipmentData = {};
                loads.forEach(load => {
                    equipmentData[load.equipment_type] = (equipmentData[load.equipment_type] || 0) + 1;
                });

                new Chart(document.getElementById('equipmentChart'), {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(equipmentData),
                        datasets: [{
                            data: Object.values(equipmentData),
                            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });

                // Call outcomes chart
                new Chart(document.getElementById('outcomesChart'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Booked', 'Declined', 'No Match', 'Callback Needed'],
                        datasets: [{
                            data: [
                                metrics.booked_calls || 0,
                                metrics.declined_calls || 0,
                                metrics.no_match_calls || 0,
                                metrics.callback_needed || 0
                            ],
                            backgroundColor: ['#4CAF50', '#f44336', '#FF9800', '#2196F3']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });

                // 7-day activity chart
                const activityData = metrics.recent_activity || [];
                new Chart(document.getElementById('activityChart'), {
                    type: 'line',
                    data: {
                        labels: activityData.map(d => d.date),
                        datasets: [{
                            label: 'Total Calls',
                            data: activityData.map(d => d.calls),
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            fill: true
                        }, {
                            label: 'Booked Calls',
                            data: activityData.map(d => d.booked),
                            borderColor: '#4CAF50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });

                // Top carriers chart
                const carriersData = metrics.top_carriers || [];
                new Chart(document.getElementById('carriersChart'), {
                    type: 'bar',
                    data: {
                        labels: carriersData.map(c => `MC ${c.mc_number}`),
                        datasets: [{
                            label: 'Total Calls',
                            data: carriersData.map(c => c.call_count),
                            backgroundColor: '#764ba2'
                        }, {
                            label: 'Booked Calls',
                            data: carriersData.map(c => c.booked_count),
                            backgroundColor: '#4CAF50'
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });

                // Duration by outcome chart
                const durationData = metrics.duration_by_outcome || [];
                new Chart(document.getElementById('durationChart'), {
                    type: 'bar',
                    data: {
                        labels: durationData.map(d => d.outcome),
                        datasets: [{
                            label: 'Avg Duration (seconds)',
                            data: durationData.map(d => d.avg_duration),
                            backgroundColor: '#FF9800'
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });

                // Hourly distribution chart
                const hourlyData = metrics.hourly_calls || [];
                new Chart(document.getElementById('hourlyChart'), {
                    type: 'line',
                    data: {
                        labels: hourlyData.map(h => `${h.hour}:00`),
                        datasets: [{
                            label: 'Calls per Hour',
                            data: hourlyData.map(h => h.calls),
                            borderColor: '#9C27B0',
                            backgroundColor: 'rgba(156, 39, 176, 0.1)',
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });

            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        function refreshDashboard() {
            loadDashboardData();
        }

        // Load data on page load and refresh every 30 seconds
        loadDashboardData();
        setInterval(loadDashboardData, 30000);
    </script>
</body>
</html>
