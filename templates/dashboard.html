<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HappyRobot Inbound Carrier Sales Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        .metric-label {
            color: #666;
            font-size: 0.9em;
        }
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .chart-container {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .chart-container canvas {
            max-height: 200px !important;
        }
        .chart-title {
            font-size: 1em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        .no-data {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 20px;
        }
        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin: 10px 0;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        .refresh-btn:hover {
            background: #5a6fd8;
        }
        .api-links {
            text-align: center;
            margin-top: 30px;
        }
        .api-links a {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin: 5px;
        }
        .api-links a:hover {
            background: #5a6fd8;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöõ HappyRobot Inbound Carrier Sales</h1>
        <p>Real-time Dashboard & Analytics</p>
    </div>

    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-label">Total Loads Available</div>
            <div class="metric-value" id="total-loads">-</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Total Calls</div>
            <div class="metric-value" id="total-calls">-</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Today's Calls</div>
            <div class="metric-value" id="today-calls">-</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">This Week's Calls</div>
            <div class="metric-value" id="week-calls">-</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Success Rate</div>
            <div class="metric-value" id="success-rate">-</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Callback Needed</div>
            <div class="metric-value" id="callback-needed">-</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Positive Sentiment</div>
            <div class="metric-value" id="positive-sentiment">-</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Negative Sentiment</div>
            <div class="metric-value" id="negative-sentiment">-</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Neutral Sentiment</div>
            <div class="metric-value" id="neutral-sentiment">-</div>
        </div>
    </div>

    <div class="charts-grid">
        <div class="chart-container">
            <div class="chart-title">üìä Equipment Types</div>
            <canvas id="equipmentChart" width="400" height="200"></canvas>
        </div>

        <div class="chart-container" id="outcomesContainer">
            <div class="chart-title">üìà Call Outcomes</div>
            <canvas id="outcomesChart" width="400" height="200"></canvas>
        </div>

        <div class="chart-container" id="activityContainer">
            <div class="chart-title">üìà 7-Day Activity</div>
            <canvas id="activityChart" width="400" height="200"></canvas>
        </div>

        <div class="chart-container" id="carriersContainer">
            <div class="chart-title">üöõ Top Carriers</div>
            <canvas id="carriersChart" width="400" height="200"></canvas>
        </div>


        <div class="chart-container" id="hourlyContainer">
            <div class="chart-title">üïê Hourly Distribution</div>
            <canvas id="hourlyChart" width="400" height="200"></canvas>
        </div>

        <div class="chart-container" id="sentimentContainer">
            <div class="chart-title">üòä Carrier Sentiment</div>
            <canvas id="sentimentChart" width="400" height="200"></canvas>
        </div>
    </div>

    <button class="refresh-btn" onclick="refreshDashboard()">üîÑ Refresh Data</button>

    <div class="api-links">
        <a href="/docs">API Documentation</a>
        <a href="/dashboard-metrics">Raw Metrics JSON</a>
    </div>

    <script>
        // Load dashboard data
        async function loadDashboardData() {
            try {
                const metrics = await fetch('/dashboard-metrics').then(r => r.json());

                // Update metric cards
                document.getElementById('total-loads').textContent = metrics.total_loads || 0;
                document.getElementById('total-calls').textContent = metrics.total_calls || 0;
                document.getElementById('today-calls').textContent = metrics.today_calls || 0;
                document.getElementById('week-calls').textContent = metrics.week_calls || 0;
                document.getElementById('success-rate').textContent = (metrics.success_rate || 0) + '%';
                document.getElementById('callback-needed').textContent = metrics.callback_needed || 0;
                document.getElementById('positive-sentiment').textContent = metrics.positive_sentiment || 0;
                document.getElementById('negative-sentiment').textContent = metrics.negative_sentiment || 0;
                document.getElementById('neutral-sentiment').textContent = metrics.neutral_sentiment || 0;

                // Equipment type chart - use available loads from metrics
                const equipmentData = {};
                if (metrics.available_loads && metrics.available_loads > 0) {
                    // For now, show a simple distribution since we don't have detailed load data
                    equipmentData['Dry Van'] = Math.floor(metrics.available_loads * 0.4);
                    equipmentData['Flatbed'] = Math.floor(metrics.available_loads * 0.3);
                    equipmentData['Reefer'] = Math.floor(metrics.available_loads * 0.2);
                    equipmentData['Power Only'] = Math.floor(metrics.available_loads * 0.1);
                }

                new Chart(document.getElementById('equipmentChart'), {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(equipmentData),
                        datasets: [{
                            data: Object.values(equipmentData),
                            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    font: { size: 10 }
                                }
                            }
                        }
                    }
                });

                // Call outcomes chart - only show if there are calls
                const totalCalls = (metrics.booked_calls || 0) + (metrics.declined_calls || 0) + (metrics.no_match_calls || 0) + (metrics.callback_needed || 0);
                if (totalCalls > 0) {
                    new Chart(document.getElementById('outcomesChart'), {
                        type: 'doughnut',
                        data: {
                            labels: ['Booked', 'Declined', 'No Match', 'Callback Needed'],
                            datasets: [{
                                data: [
                                    metrics.booked_calls || 0,
                                    metrics.declined_calls || 0,
                                    metrics.no_match_calls || 0,
                                    metrics.callback_needed || 0
                                ],
                                backgroundColor: ['#4CAF50', '#f44336', '#FF9800', '#2196F3']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        font: { size: 10 }
                                    }
                                }
                            }
                        }
                    });
                } else {
                    document.getElementById('outcomesContainer').innerHTML = '<div class="chart-title">üìà Call Outcomes</div><div class="no-data">No call data available yet</div>';
                }

                // 7-day activity chart - only show if there's activity
                const activityData = metrics.recent_activity || [];
                const hasActivity = activityData.some(d => d.calls > 0);
                if (hasActivity) {
                    new Chart(document.getElementById('activityChart'), {
                        type: 'line',
                        data: {
                            labels: activityData.map(d => d.date),
                            datasets: [{
                                label: 'Total Calls',
                                data: activityData.map(d => d.calls),
                                borderColor: '#667eea',
                                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                fill: true
                            }, {
                                label: 'Booked Calls',
                                data: activityData.map(d => d.booked),
                                borderColor: '#4CAF50',
                                backgroundColor: 'rgba(76, 175, 80, 0.1)',
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { font: { size: 10 } }
                                },
                                x: {
                                    ticks: { font: { size: 10 } }
                                }
                            },
                            plugins: {
                                legend: {
                                    labels: { font: { size: 10 } }
                                }
                            }
                        }
                    });
                } else {
                    document.getElementById('activityContainer').innerHTML = '<div class="chart-title">üìà 7-Day Activity</div><div class="no-data">No activity data available yet</div>';
                }

                // Top carriers chart - only show if there are carriers
                const carriersData = metrics.top_carriers || [];
                if (carriersData.length > 0) {
                    new Chart(document.getElementById('carriersChart'), {
                        type: 'bar',
                        data: {
                            labels: carriersData.map(c => c.carrier_name || `MC ${c.mc_number}`),
                            datasets: [{
                                label: 'Total Calls',
                                data: carriersData.map(c => c.call_count),
                                backgroundColor: '#764ba2'
                            }, {
                                label: 'Booked Calls',
                                data: carriersData.map(c => c.booked_count),
                                backgroundColor: '#4CAF50'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { font: { size: 10 } }
                                },
                                x: {
                                    ticks: { font: { size: 10 } }
                                }
                            },
                            plugins: {
                                legend: {
                                    labels: { font: { size: 10 } }
                                }
                            }
                        }
                    });
                } else {
                    document.getElementById('carriersContainer').innerHTML = '<div class="chart-title">üöõ Top Carriers</div><div class="no-data">No carrier data available yet</div>';
                }


                // Hourly distribution chart - only show if there are hourly calls
                const hourlyData = metrics.hourly_calls || [];
                const hasHourlyCalls = hourlyData.some(h => h.calls > 0);
                if (hasHourlyCalls) {
                    new Chart(document.getElementById('hourlyChart'), {
                        type: 'line',
                        data: {
                            labels: hourlyData.map(h => `${h.hour}:00`),
                            datasets: [{
                                label: 'Calls per Hour',
                                data: hourlyData.map(h => h.calls),
                                borderColor: '#9C27B0',
                                backgroundColor: 'rgba(156, 39, 176, 0.1)',
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { font: { size: 10 } }
                                },
                                x: {
                                    ticks: { font: { size: 10 } }
                                }
                            },
                            plugins: {
                                legend: {
                                    labels: { font: { size: 10 } }
                                }
                            }
                        }
                    });
                } else {
                    document.getElementById('hourlyContainer').innerHTML = '<div class="chart-title">üïê Hourly Distribution</div><div class="no-data">No hourly data available yet</div>';
                }

                // Sentiment chart - only show if there's sentiment data
                const totalSentiment = (metrics.positive_sentiment || 0) + (metrics.negative_sentiment || 0) + (metrics.neutral_sentiment || 0);
                if (totalSentiment > 0) {
                    new Chart(document.getElementById('sentimentChart'), {
                        type: 'doughnut',
                        data: {
                            labels: ['Positive', 'Negative', 'Neutral'],
                            datasets: [{
                                data: [
                                    metrics.positive_sentiment || 0,
                                    metrics.negative_sentiment || 0,
                                    metrics.neutral_sentiment || 0
                                ],
                                backgroundColor: ['#4CAF50', '#f44336', '#FF9800']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        font: { size: 10 }
                                    }
                                }
                            }
                        }
                    });
                } else {
                    document.getElementById('sentimentContainer').innerHTML = '<div class="chart-title">üòä Carrier Sentiment</div><div class="no-data">No sentiment data available yet</div>';
                }

            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        function refreshDashboard() {
            loadDashboardData();
        }

        // Load data on page load and refresh every 30 seconds
        loadDashboardData();
        setInterval(loadDashboardData, 30000);
    </script>
</body>
</html>
